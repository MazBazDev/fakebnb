name: CI/CD

on:
  push:
    branches:
      - master

permissions:
  contents: read

env:
  IMAGE_API: ${{ secrets.IMAGE_API }}
  IMAGE_APP: ${{ secrets.IMAGE_APP }}
  REGISTRY_HOST: ${{ secrets.REGISTRY_HOST }}

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          tools: composer:v2
          extensions: bcmath, exif, gd, intl, pcntl, pdo_sqlite, sqlite3, zip

      - name: Install dependencies
        working-directory: apps/api
        run: composer install --no-interaction --prefer-dist

      - name: Prepare test env
        working-directory: apps/api
        run: |
          cp -n .env.example .env || true
          echo "DB_CONNECTION=sqlite" >> .env
          echo "DB_DATABASE=${{ github.workspace }}/apps/api/database/testing.sqlite" >> .env
          php artisan key:generate --force
          php artisan passport:keys --force || true
          mkdir -p database
          php -r "file_exists('database/testing.sqlite') || touch('database/testing.sqlite');"

      - name: Run tests
        working-directory: apps/api
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ${{ github.workspace }}/apps/api/database/testing.sqlite
        run: |
          rm -f database/testing.sqlite
          php -r "touch('database/testing.sqlite');"
          php artisan migrate:fresh --seed --env=testing
          php artisan test --compact

  test-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: apps/app/package-lock.json

      - name: Install dependencies
        working-directory: apps/app
        run: npm ci

      - name: Run tests
        working-directory: apps/app
        env:
          CI: "1"
        run: npm run test:unit

  build-and-push:
    runs-on: ubuntu-latest
    needs:
      - test-api
      - test-app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Docker metadata (api)
        id: meta_api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_API }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push (api)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/prod/Dockerfile.api
          push: true
          tags: ${{ steps.meta_api.outputs.tags }}
          labels: ${{ steps.meta_api.outputs.labels }}

      - name: Docker metadata (app)
        id: meta_app
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_APP }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push (app)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: infra/prod/Dockerfile.app
          push: true
          tags: ${{ steps.meta_app.outputs.tags }}
          labels: ${{ steps.meta_app.outputs.labels }}
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            VITE_REVERB_APP_KEY=${{ secrets.VITE_REVERB_APP_KEY }}
            VITE_REVERB_HOST=${{ secrets.VITE_REVERB_HOST }}
            VITE_REVERB_PORT=${{ secrets.VITE_REVERB_PORT }}
            VITE_REVERB_SCHEME=${{ secrets.VITE_REVERB_SCHEME }}
            VITE_REVERB_AUTH_ENDPOINT=${{ secrets.VITE_REVERB_AUTH_ENDPOINT }}

  deploy:
    runs-on: ubuntu-latest
    needs:
      - build-and-push
    steps:
      - name: Debug deploy vars
        run: |
          echo "REGISTRY_HOST=${REGISTRY_HOST}"
          echo "REGISTRY_USERNAME=${REGISTRY_USERNAME:+set}"
          echo "REGISTRY_PASSWORD=${REGISTRY_PASSWORD:+set}"
          echo "IMAGE_API=${IMAGE_API}"
          echo "IMAGE_APP=${IMAGE_APP}"
          echo "VPS_HOST=${VPS_HOST:+set}"
          echo "VPS_USER=${VPS_USER:+set}"
          echo "VPS_SSH_KEY=${VPS_SSH_KEY:+set}"
          echo "VPS_PATH=${VPS_PATH}"
        env:
          REGISTRY_HOST: ${{ secrets.REGISTRY_HOST }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          IMAGE_API: ${{ secrets.IMAGE_API }}
          IMAGE_APP: ${{ secrets.IMAGE_APP }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: '2214'
          debug: true
          script_stop: true
          script: |
            cd "${{ secrets.VPS_PATH }}"
            REGISTRY_HOST="${{ secrets.REGISTRY_HOST }}" \
            REGISTRY_USERNAME="${{ secrets.REGISTRY_USERNAME }}" \
            REGISTRY_PASSWORD="${{ secrets.REGISTRY_PASSWORD }}" \
            IMAGE_API="${{ secrets.IMAGE_API }}" \
            IMAGE_APP="${{ secrets.IMAGE_APP }}" \
            ./infra/prod/deploy.sh

  registry-login-test:
    runs-on: ubuntu-latest
    needs:
      - build-and-push
    steps:
      - name: Test registry login over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: '2214'
          debug: true
          script_stop: true
          script: |
            REGISTRY_HOST="${{ secrets.REGISTRY_HOST }}" \
            REGISTRY_USERNAME="${{ secrets.REGISTRY_USERNAME }}" \
            REGISTRY_PASSWORD="${{ secrets.REGISTRY_PASSWORD }}" \
            bash -lc 'REGISTRY_HOST_CLEAN="${REGISTRY_HOST#http://}"; REGISTRY_HOST_CLEAN="${REGISTRY_HOST_CLEAN#https://}"; REGISTRY_HOST_CLEAN="${REGISTRY_HOST_CLEAN%%/*}"; REGISTRY_USERNAME_CLEAN="$(printf "%s" "${REGISTRY_USERNAME}" | tr -d "\r\n")"; REGISTRY_PASSWORD_CLEAN="$(printf "%s" "${REGISTRY_PASSWORD}" | tr -d "\r\n")"; echo "Login test: ${REGISTRY_HOST_CLEAN} (user: ${REGISTRY_USERNAME_CLEAN}, pass_len: ${#REGISTRY_PASSWORD_CLEAN})"; printf "%s" "${REGISTRY_PASSWORD_CLEAN}" | docker login "${REGISTRY_HOST_CLEAN}" -u "${REGISTRY_USERNAME_CLEAN}" --password-stdin'

name: fakebnb

services:
  init:
    image: alpine:3.20
    working_dir: /workspace
    volumes:
      - ..:/workspace
    entrypoint: ["/bin/sh", "-c"]
    command: "apk add --no-cache openssl >/dev/null && ./infra/init.sh"
    networks:
      - app

  api:
    build:
      context: ..
      dockerfile: infra/Dockerfile.api
    image: fakebnb-api
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "${APP_URL:-http://localhost:8989}"
      APP_KEY: "${APP_KEY}"
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      SESSION_DRIVER: file
      CACHE_STORE: file
      QUEUE_CONNECTION: database
      BROADCAST_CONNECTION: reverb
      REVERB_APP_ID: "${REVERB_APP_ID:-local}"
      REVERB_APP_KEY: "${REVERB_APP_KEY:-local}"
      REVERB_APP_SECRET: "${REVERB_APP_SECRET:-local}"
      REVERB_HOST: "${REVERB_HOST:-localhost}"
      REVERB_PORT: "${REVERB_PORT:-8080}"
      REVERB_SCHEME: "${REVERB_SCHEME:-http}"
      REVERB_SERVER_HOST: 0.0.0.0
      REVERB_SERVER_PORT: 8080
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_FROM_ADDRESS: "hello@example.com"
      MAIL_FROM_NAME: "Fakebnb"
      RUN_MIGRATIONS: "true"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/api/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 6
    ports:
      - "8989:80"
    depends_on:
      - redis
    networks:
      - app

  api.queue:
    image: fakebnb-api
    env_file:
      - ./.env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "${APP_URL:-http://localhost:8989}"
      APP_KEY: "${APP_KEY}"
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      SESSION_DRIVER: file
      CACHE_STORE: file
      QUEUE_CONNECTION: database
      BROADCAST_CONNECTION: reverb
      REVERB_APP_ID: "${REVERB_APP_ID:-local}"
      REVERB_APP_KEY: "${REVERB_APP_KEY:-local}"
      REVERB_APP_SECRET: "${REVERB_APP_SECRET:-local}"
      REVERB_HOST: "${REVERB_HOST:-localhost}"
      REVERB_PORT: "${REVERB_PORT:-8080}"
      REVERB_SCHEME: "${REVERB_SCHEME:-http}"
      REVERB_SERVER_HOST: 0.0.0.0
      REVERB_SERVER_PORT: 8080
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_FROM_ADDRESS: "hello@example.com"
      MAIL_FROM_NAME: "Fakebnb"
      RUN_MIGRATIONS: "false"
    command: php artisan queue:work --tries=1
    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app

  api.reverb:
    image: fakebnb-api
    env_file:
      - ./.env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: "${APP_URL:-http://localhost:8989}"
      APP_KEY: "${APP_KEY}"
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      SESSION_DRIVER: file
      CACHE_STORE: file
      QUEUE_CONNECTION: database
      BROADCAST_CONNECTION: reverb
      REVERB_APP_ID: "${REVERB_APP_ID:-local}"
      REVERB_APP_KEY: "${REVERB_APP_KEY:-local}"
      REVERB_APP_SECRET: "${REVERB_APP_SECRET:-local}"
      REVERB_HOST: "${REVERB_HOST:-localhost}"
      REVERB_PORT: "${REVERB_PORT:-8080}"
      REVERB_SCHEME: "${REVERB_SCHEME:-http}"
      REVERB_SERVER_HOST: 0.0.0.0
      REVERB_SERVER_PORT: 8080
      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_FROM_ADDRESS: "hello@example.com"
      MAIL_FROM_NAME: "Fakebnb"
      RUN_MIGRATIONS: "false"
    command: php artisan reverb:start --host=0.0.0.0 --port=8080
    ports:
      - "8080:8080"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app

  app:
    build:
      context: ..
      dockerfile: infra/Dockerfile.app
      args:
        VITE_API_URL: "${VITE_API_URL:-http://localhost:8989/api/v1}"
        VITE_REVERB_APP_KEY: "${VITE_REVERB_APP_KEY:-local}"
        VITE_REVERB_HOST: "${VITE_REVERB_HOST:-localhost}"
        VITE_REVERB_PORT: "${VITE_REVERB_PORT:-8080}"
        VITE_REVERB_SCHEME: "${VITE_REVERB_SCHEME:-http}"
        VITE_REVERB_AUTH_ENDPOINT: "${VITE_REVERB_AUTH_ENDPOINT:-http://localhost:8989/broadcasting/auth}"
    env_file:
      - ./.env
    ports:
      - "5173:80"
    networks:
      - app

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - app

  redis:
    image: redis:alpine
    volumes:
      - fakebnb-redis:/data
    networks:
      - app
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      retries: 3
      timeout: 5s

networks:
  app:
    driver: bridge

volumes:
  fakebnb-redis:
    driver: local
